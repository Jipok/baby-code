<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>

</head>

<body>
  <div class="version">v0.0.1</div>
  <div id="main_output_container"
    style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <div style="display: flex; justify-content: center; align-items: center;">
      <h2>BABY</h2>
      <div
        style="position: relative; display: flex; flex-direction: column; align-items: center; margin: 0px -5px -20px;">
        <h2 id="interpreter">INTERPRETER</h2>
        <img id="logo1" class="logo" src="assets/logos/baby-llama-logo.png" alt="logo"
          style="height: 120px; width: auto; position: absolute;"
          title="DALL-E: a cartoon-ish baby llama that wants to interpret python code dressed up as the grim reaper">
        <img id="logo2" class="logo" src="assets/logos/baby-llama-logo2.png" alt="logo"
          style="height: 120px; width: auto; position: absolute;"
          title="DALL-E: (v2) a cartoon-ish baby llama that wants to interpret python code dressed up as the grim reaper">
        <img id="logo3" class="logo" src="assets/logos/baby-llama-logo3.png" alt="logo"
          style="height: 120px; width: auto; position: absolute;"
          title="DALL-E: (V3) a cartoon-ish baby llama that wants to interpret python code dressed up as the grim reaper">
      </div>
      <h2>CODE</h2>
    </div>
  </div>
  <div class="container">
    <div class="panel panel-default">
      <div class="panel-body">
        <pre>
          <code id="output" class="language-python"></code>
      </pre>
      </div>
    </div>
  </div>
  <div id="footer-buttons" style="display: flex; justify-content: center; flex-wrap: wrap;">
    <button id="btn1" title="WIP"
      style="height: 8.9mm; width: 8.9mm; background-image: url('./assets/btns/iterate_btn.png'); background-repeat: no-repeat; background-size: cover; background-position: center;">Button
      1</button>
    <button id="btn2" title="WIP"
      style="height: 8.5mm; width: 8.5mm; background-image: url('./assets/btns/randomize_btn.png'); background-repeat: no-repeat; background-size: cover; background-position: center;">Button
      2</button>
    <button id="btn3" title="WIP"
      style="height: 7.5mm; width: 7.5mm; background-image: url('./assets/btns/upload_btn.png'); background-repeat: no-repeat; background-size: cover; background-position: center;">Button
      3</button>
    <button id="btn4" title="WIP"
      style="height: 6mm; width: 6mm; background-image: url('./assets/btns/history_btn.png'); background-repeat: no-repeat; background-size: cover; background-position: center;">Button
      4</button>
    <button id="btn5" title="WIP"
      style="height: 6mm; width: 6mm; background-image: url('./assets/btns/share_btn.png'); background-repeat: no-repeat; background-size: cover; background-position: center;">Button
      5</button>
  </div>
  <button id="sendButton" class="hoverable" onclick="sendCode()"
    title="borrowed from stackoverflow:) @ https://stackoverflow.com/a/58694475"></button>
  <textarea id="code" placeholder="enter prompt & hit &#x1F34C;" style="text-align: center;"></textarea>
  <div class="slider">
    <div class="slide-track">
      <div class="slide">
        <a href="https://github.com/langchain-ai/langchain" target="_blank">
          <img style="padding-bottom: 30px;" src="assets/footer/langchain.png" height="100" width="100" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://html.com/" target="_blank">
          <img style="padding-bottom: 67px;" src="assets/footer/html_css_js.png" height="30" width="100" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://ai.meta.com/llama/" target="_blank">
          <img style="padding-bottom: 55px;" src="assets/footer/meta_llama_2.png" height="50" width="80" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://www.python.org/" target="_blank">
          <img style="padding-bottom: 56px;" src="assets/footer/python.png" height="50" width="80" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://github.com/ggerganov/llama.cpp" target="_blank">
          <img style="padding-bottom: 67px;" src="assets/footer/llama_cpp.png" height="35" width="50" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://github.com/langchain-ai/langchain" target="_blank">
          <img style="padding-bottom: 30px;" src="assets/footer/langchain.png" height="100" width="100" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://html.com/" target="_blank">
          <img style="padding-bottom: 67px;" src="assets/footer/html_css_js.png" height="30" width="100" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://ai.meta.com/llama/" target="_blank">
          <img style="padding-bottom: 55px;" src="assets/footer/meta_llama_2.png" height="50" width="80" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://www.python.org/" target="_blank">
          <img style="padding-bottom: 56px;" src="assets/footer/python.png" height="50" width="80" alt="" />
        </a>
      </div>
      <div class="slide">
        <a href="https://github.com/ggerganov/llama.cpp" target="_blank">
          <img style="padding-bottom: 62px;" src="assets/footer/llama_cpp.png" height="35" width="50" alt="" />
        </a>
      </div>
      <div class="slide">
        <p style="color: white; padding: 5px;">Made possible by open source;</p>
      </div>
    </div>
    
  </div>
  <script>
    const sendButton = document.getElementById("sendButton");
    const output = document.getElementById("output");

    const codeTextarea = document.getElementById('code');

    codeTextarea.oninput = function () {
      this.style.textAlign = this.value ? 'left' : 'center';
    };

    let responses = [];

    function makeEditable() {
      // Toggle editability
      output.readOnly = !output.readOnly;

      // Change caret color based on editability
      if (output.readOnly) {
        output.style.caretColor = 'transparent';
      } else {
        output.style.caretColor = 'auto';

        // Focus textarea when made editable
        output.focus();
        output.value = output.placeholder;
      }
    }

    let currentLogo = 1;

    function animateLogo() {
      // Fade out and lower z-index of current logo
      const currentLogoElement = document.getElementById(`logo${currentLogo}`);
      currentLogoElement.style.opacity = '0';
      currentLogoElement.style.zIndex = '0';

      // Increment currentLogo, looping back to 1 if necessary
      currentLogo = currentLogo % 3 + 1;

      // Fade in and raise z-index of next logo
      const nextLogoElement = document.getElementById(`logo${currentLogo}`);
      nextLogoElement.style.opacity = '1';
      nextLogoElement.style.zIndex = '1';
    }


    // Call animateLogo every second
    setInterval(animateLogo, 3500);

    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");
    const footerButtons = document.getElementById('footer-buttons');

    window.onload = function () {
      const btn1 = document.getElementById("btn1");

      btn1.addEventListener('click', function () {
        const pythonCode = document.getElementById('output').value;
        fetch('/run_python_code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code: pythonCode })
        })
          .then(response => response.json())
          .then(data => {
            console.log(data.result);
          });
      });
    }

    document.getElementById('code').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim() !== '') {
          sendCode();
        }
      }
    });

    output.addEventListener('keydown', e => {
      // Check if Shift+Enter was pressed
      if (e.shiftKey && e.key === 'Enter') {
        // Prevent browser from inserting newline
        e.preventDefault();

        // If already in edit mode, update placeholder and clear text
        if (!output.readOnly) {
          // Get current text
          const text = e.target.value;

          // Update placeholder with current text
          e.target.placeholder = text;

          // Reset value to empty string
          e.target.value = "";
        }
        else {
          // Toggle editability
          output.readOnly = !output.readOnly;

          // Change caret color based on editability
          if (output.readOnly) {
            output.style.caretColor = 'transparent';
          } else {
            output.style.caretColor = 'auto';

            // Focus textarea when made editable
            output.focus();
            output.value = output.placeholder;
          }
        }
      }
    });

    async function sendCode() {
      document.querySelector(".hoverable").style.backgroundImage = "url('https://i.stack.imgur.com/WwxRR.gif')";
      document.getElementById('output').value = "";

      try {
        const question = document.getElementById('code').value;
        document.getElementById('code').value = '';
        const messages = [
          {
            "role": "user",
            "content": question
          }
        ];

        appendMessage(question, 'user');

        const response = await fetch('http://localhost:8081/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            messages: messages
          })
        });

        if (!response.ok) {
          const message = `An error has occurred: ${response.status}`;
          throw new Error(message);
        }

        const data = await response.json();

        const code = data.choices[0].message.content;

        // Store the response in the responses array
        responses.push({
          message: code,
          sender: 'assistant',
        });
        appendMessage(code, 'assistant');

        // Highlight the code
        Prism.highlightAll();

        document.querySelector(".hoverable").style.backgroundImage = "url('https://i.stack.imgur.com/mJHTA.png')";

        document.getElementById('output').value = code;

      } catch (error) {
        console.log(error);
        document.getElementById('output').style.color = 'red';
        document.getElementById('output').value = "Error: " + error.message;
        document.querySelector(".hoverable").style.backgroundImage = "url('https://i.stack.imgur.com/mJHTA.png')";
      }
    }
    function appendMessages() {
      // Clear the parent div
      output.parentNode.innerHTML = '';

      // Append each message in the responses array
      for (let i = 0; i < responses.length; i++) {
        appendMessage(responses[i].message, responses[i].sender);
      }
    }
    function appendMessage(message, sender) {
      // Create new 'pre', 'code', and 'p' elements for the message
      const messagePre = document.createElement('pre');
      const messageCode = document.createElement('code');
      const messagePrefix = document.createElement('p');

      // Set the 'class' and 'textContent' of the 'code' element
      messageCode.className = `language-python ${sender}`;
      messageCode.textContent = message;

      // Set the 'textContent' of the 'p' element
      messagePrefix.textContent = sender === 'assistant' ? 'Llama:' : 'Human:';

      // Append the 'p' element to the 'pre' element
      messagePre.appendChild(messagePrefix);

      // Append the 'code' element to the 'pre' element
      messagePre.appendChild(messageCode);

      // Append the 'pre' element to the container div
      const container = document.querySelector('.container');
      messagePre.className = 'fade-in';
      container.appendChild(messagePre);

      // Apply syntax highlighting to the new code block
      Prism.highlightElement(messageCode);
    }

  </script>
</body>

</html>